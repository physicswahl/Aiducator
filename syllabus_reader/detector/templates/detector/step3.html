{% extends 'aigames/gamepage.html' %}
{% load static %}

{% block title %}{{ step_name }} - {{ matchup.ai_game.title }}{% endblock %}

{% block extra_step_css %}
<link rel="stylesheet" href="{% static 'detector/css/steps.css' %}">
<style>
    .map-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 2rem;
        width: 100%;
        max-width: 100%;
    }
    
    .map-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
    }
    
    .map-wrapper {
        width: 100%;
        height: 500px;
        position: relative;
        overflow: hidden;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #schoolMap {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border: none;
        display: block;
    }
    
    .school-info {
        padding: 1.5rem;
        background: #f8f9fa;
        border-top: 3px solid #667eea;
    }
    
    .school-info h5 {
        color: #495057;
        margin-bottom: 1rem;
    }
    
    .info-item {
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background: white;
        border-radius: 6px;
        border-left: 4px solid #667eea;
    }
    
    .info-item strong {
        color: #495057;
    }
    
    .detection-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .detection-status {
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        border-left: 4px solid #28a745;
        background: #d4edda;
        color: #155724;
    }
    
    /* Ensure no conflicts with gamepage template */
    .step-content {
        overflow: visible !important;
    }
    
    .detector-form-section {
        width: 100%;
        overflow: visible;
    }
</style>
{% endblock %}

{% block step_content %}
<!-- Step 3 Specific Content - Map Analysis -->
<div class="detector-form-section">
    <!-- School Location Map -->
    <div class="map-container">
        <div class="map-header">
            <h5><i class="fas fa-map-marker-alt me-2"></i>Target Location Analysis</h5>
            <p class="mb-0">Analyzing the geographic location and environment of {{ school_data.name }}</p>
        </div>
        
        <div class="map-wrapper">
            <div class="map-container-with-overlay" style="position: relative; width: 100%; height: 100%;">
                <img id="schoolMap" 
                     src="{% static 'detector/images/LGB.png' %}"
                     alt="Map of {{ school_data.name }}"
                     style="width: 100%; height: 100%; object-fit: cover; border: none; display: block;">
                
                <!-- SVG Overlay for polygon -->
                <svg id="polygonOverlay" 
                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
                    <defs>
                        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="2" dy="2" stdDeviation="3" flood-color="rgba(0,0,0,0.3)"/>
                        </filter>
                    </defs>
                    
                    <!-- Detection area polygon -->
                    <polygon id="detectionPolygon" 
                             points="200,150 300,100, 400,150 400,350 200,350" 
                             fill="rgba(34, 197, 94, 0.5)" 
                             stroke="rgba(34, 197, 94, 0.8)" 
                             stroke-width="2"
                             filter="url(#shadow)"
                             style="pointer-events: auto; cursor: pointer;"/>
                    
                    <!-- Vertex circles -->
                    <g id="vertexGroup">
                        <circle class="vertex" data-index="0" cx="200" cy="150" r="6" 
                                fill="white" stroke="rgba(34, 197, 94, 1)" stroke-width="2" 
                                style="pointer-events: auto; cursor: move;" filter="url(#shadow)"/>
                        <circle class="vertex" data-index="1" cx="300" cy="100" r="6" 
                                fill="white" stroke="rgba(34, 197, 94, 1)" stroke-width="2" 
                                style="pointer-events: auto; cursor: move;" filter="url(#shadow)"/>
                        <circle class="vertex" data-index="2" cx="400" cy="150" r="6" 
                                fill="white" stroke="rgba(34, 197, 94, 1)" stroke-width="2" 
                                style="pointer-events: auto; cursor: move;" filter="url(#shadow)"/>
                        <circle class="vertex" data-index="3" cx="400" cy="350" r="6" 
                                fill="white" stroke="rgba(34, 197, 94, 1)" stroke-width="2" 
                                style="pointer-events: auto; cursor: move;" filter="url(#shadow)"/>
                        <circle class="vertex" data-index="4" cx="200" cy="350" r="6" 
                                fill="white" stroke="rgba(34, 197, 94, 1)" stroke-width="2" 
                                style="pointer-events: auto; cursor: move;" filter="url(#shadow)"/>
                    </g>
                </svg>
                
            </div>
        </div>
        
        <div class="school-info">
            <h5><i class="fas fa-info-circle me-2"></i>Location Details</h5>
            <div class="info-item">
                <strong>School Name:</strong> {{ school_data.name }}
            </div>
            <div class="info-item">
                <strong>OpenStreetMap Way ID:</strong> {{ school_data.osm_way_id }}
            </div>
            <div class="info-item">
                <strong>Coordinates:</strong> {{ school_data.latitude }}°N, {{ school_data.longitude }}°E
            </div>
            <div class="info-item">
                <strong>Address:</strong> {{ school_data.address }}
            </div>
        </div>
    </div>
    
    <!-- Detection Analysis Panel -->
    <div class="detection-panel">
        <h5><i class="fas fa-search me-2"></i>Environmental Detection Analysis</h5>
        <p>Based on the location data and environmental factors, analyze the detection parameters for this educational facility.</p>
        
        <div class="detection-status">
            <i class="fas fa-check-circle me-2"></i>
            <strong>Location Loaded:</strong> Successfully identified target location with OpenStreetMap integration.
        </div>
        
        <form method="post" id="step3Form">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="environmental_factors" class="form-label">
                            <i class="fas fa-leaf me-1"></i>Environmental Factors Observed
                        </label>
                        <textarea class="form-control" 
                                id="environmental_factors" 
                                name="environmental_factors" 
                                rows="4" 
                                placeholder="Describe environmental factors visible on the map that could affect detection...">{{ team_data.analysis_data.environmental_factors|default:"" }}</textarea>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="location_analysis" class="form-label">
                            <i class="fas fa-chart-line me-1"></i>Location Analysis Notes
                        </label>
                        <textarea class="form-control" 
                                id="location_analysis" 
                                name="location_analysis" 
                                rows="4" 
                                placeholder="Analyze the geographic context and how it relates to your detection objectives...">{{ team_data.analysis_data.location_analysis|default:"" }}</textarea>
                    </div>
                </div>
            </div>
            
            <div class="form-group mb-3">
                <label for="detection_parameters" class="form-label">
                    <i class="fas fa-cogs me-1"></i>Updated Detection Parameters
                </label>
                <select class="form-select" id="detection_parameters" name="detection_parameters">
                    <option value="">Select detection parameters based on location analysis...</option>
                    <option value="urban_environment" {% if team_data.analysis_data.detection_parameters == "urban_environment" %}selected{% endif %}>Urban Environment - High Traffic</option>
                    <option value="educational_facility" {% if team_data.analysis_data.detection_parameters == "educational_facility" %}selected{% endif %}>Educational Facility - Moderate Activity</option>
                    <option value="residential_area" {% if team_data.analysis_data.detection_parameters == "residential_area" %}selected{% endif %}>Residential Area - Low Background</option>
                    <option value="mixed_use" {% if team_data.analysis_data.detection_parameters == "mixed_use" %}selected{% endif %}>Mixed Use - Variable Conditions</option>
                </select>
            </div>
            
            <div class="form-group mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="location_verified" name="location_verified" 
                           {% if team_data.analysis_data.location_verified %}checked{% endif %}>
                    <label class="form-check-label" for="location_verified">
                        <i class="fas fa-map-pin me-1"></i>I have verified the target location on the map
                    </label>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Save Analysis
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block step_scripts %}
<script>
// Form validation
function checkFormCompletion() {
    const environmentalFactors = document.getElementById('environmental_factors').value.trim();
    const locationAnalysis = document.getElementById('location_analysis').value.trim();
    const detectionParameters = document.getElementById('detection_parameters').value;
    const locationVerified = document.getElementById('location_verified').checked;
    
    const completeBtn = document.getElementById('completeBtn');
    
    if (environmentalFactors && locationAnalysis && detectionParameters && locationVerified) {
        if (completeBtn) {
            completeBtn.disabled = false;
            completeBtn.innerHTML = '<i class="fas fa-check me-1"></i>Complete Step 3';
            completeBtn.classList.remove('btn-secondary');
            completeBtn.classList.add('btn-success');
        }
    } else {
        if (completeBtn) {
            completeBtn.disabled = true;
            completeBtn.innerHTML = '<i class="fas fa-check me-1"></i>Complete Step 3';
            completeBtn.classList.remove('btn-success');
            completeBtn.classList.add('btn-secondary');
        }
    }
}

// Add event listeners for form validation
document.addEventListener('DOMContentLoaded', function() {
    const formElements = ['environmental_factors', 'location_analysis', 'detection_parameters', 'location_verified'];
    formElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            element.addEventListener('change', checkFormCompletion);
            element.addEventListener('input', checkFormCompletion);
        }
    });
    
    // Initial check
    checkFormCompletion();
    
    // Initialize polygon interaction
    initializePolygonEditor();
});

// Polygon editing functionality
function initializePolygonEditor() {
    let isDragging = false;
    let currentVertex = null;
    let vertices = [
        {x: 200, y: 150},
        {x: 400, y: 150},
        {x: 400, y: 350},
        {x: 200, y: 350}
    ];
    
    function updatePolygon() {
        const polygon = document.getElementById('detectionPolygon');
        const vertexGroup = document.getElementById('vertexGroup');
        
        // Update polygon points
        const points = vertices.map(v => `${v.x},${v.y}`).join(' ');
        polygon.setAttribute('points', points);
        
        // Update vertex positions
        const vertexCircles = vertexGroup.querySelectorAll('.vertex');
        vertexCircles.forEach((circle, index) => {
            if (vertices[index]) {
                circle.setAttribute('cx', vertices[index].x);
                circle.setAttribute('cy', vertices[index].y);
                circle.setAttribute('data-index', index);
            }
        });
        
        // Save polygon data to form
        savePolygonData();
    }
    
    function savePolygonData() {
        // Store polygon coordinates in a hidden form field or save via AJAX
        const polygonData = {
            vertices: vertices,
            timestamp: new Date().toISOString()
        };
        
        // You can save this to your form data
        console.log('Polygon data:', polygonData);
        
        // Optional: Auto-save to backend
        // saveFormData();
    }
    
    function addVertex() {
        if (vertices.length >= 10) {
            alert('Maximum 10 vertices allowed');
            return;
        }
        
        // Add new vertex at center of existing polygon
        const centerX = vertices.reduce((sum, v) => sum + v.x, 0) / vertices.length;
        const centerY = vertices.reduce((sum, v) => sum + v.y, 0) / vertices.length;
        
        vertices.push({x: centerX, y: centerY});
        
        // Create new vertex circle
        const vertexGroup = document.getElementById('vertexGroup');
        const newCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        newCircle.classList.add('vertex');
        newCircle.setAttribute('r', '6');
        newCircle.setAttribute('fill', 'white');
        newCircle.setAttribute('stroke', 'rgba(34, 197, 94, 1)');
        newCircle.setAttribute('stroke-width', '2');
        newCircle.setAttribute('filter', 'url(#shadow)');
        newCircle.style.pointerEvents = 'auto';
        newCircle.style.cursor = 'move';
        
        addVertexEventListeners(newCircle);
        vertexGroup.appendChild(newCircle);
        
        updatePolygon();
    }
    
    function removeVertex() {
        if (vertices.length <= 3) {
            alert('Minimum 3 vertices required');
            return;
        }
        
        vertices.pop();
        const vertexGroup = document.getElementById('vertexGroup');
        const lastVertex = vertexGroup.lastElementChild;
        if (lastVertex) {
            vertexGroup.removeChild(lastVertex);
        }
        
        updatePolygon();
    }
    
    function resetPolygon() {
        vertices = [
            {x: 200, y: 150},
            {x: 400, y: 150},
            {x: 400, y: 350},
            {x: 200, y: 350}
        ];
        
        // Remove extra vertices
        const vertexGroup = document.getElementById('vertexGroup');
        while (vertexGroup.children.length > 4) {
            vertexGroup.removeChild(vertexGroup.lastChild);
        }
        
        updatePolygon();
    }
    
    function addVertexEventListeners(vertex) {
        vertex.addEventListener('mousedown', startDrag);
        vertex.addEventListener('touchstart', startDrag);
    }
    
    function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        currentVertex = parseInt(e.target.getAttribute('data-index'));
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function drag(e) {
        if (!isDragging || currentVertex === null) return;
        
        e.preventDefault();
        const svg = document.getElementById('polygonOverlay');
        const rect = svg.getBoundingClientRect();
        
        let clientX, clientY;
        if (e.type.includes('touch')) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        const x = ((clientX - rect.left) / rect.width) * svg.viewBox.baseVal.width || (clientX - rect.left);
        const y = ((clientY - rect.top) / rect.height) * svg.viewBox.baseVal.height || (clientY - rect.top);
        
        // Constrain to SVG bounds
        const constrainedX = Math.max(0, Math.min(svg.clientWidth, x));
        const constrainedY = Math.max(0, Math.min(svg.clientHeight, y));
        
        vertices[currentVertex] = {x: constrainedX, y: constrainedY};
        updatePolygon();
    }
    
    function stopDrag() {
        isDragging = false;
        currentVertex = null;
        
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('touchend', stopDrag);
    }
    
    // Add event listeners to existing vertices
    document.querySelectorAll('.vertex').forEach(addVertexEventListeners);
    
    // Add event listeners to control buttons
    document.getElementById('addVertex').addEventListener('click', addVertex);
    document.getElementById('removeVertex').addEventListener('click', removeVertex);
    document.getElementById('resetPolygon').addEventListener('click', resetPolygon);
    
    // Initial polygon setup
    updatePolygon();
}

function completeStep(stepNumber) {
    if (confirm('Are you sure you want to complete this step?')) {
        fetch(`{% url 'detector:complete_step' matchup.id 0 %}`.replace('0', stepNumber), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                alert('Error completing step: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while completing the step.');
        });
    }
}

// Auto-save form data
function saveFormData() {
    const formData = new FormData(document.getElementById('step3Form'));
    
    fetch(`{% url 'detector:save_step_data' matchup.id %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Form data saved successfully');
        }
    })
    .catch(error => {
        console.error('Error saving form data:', error);
    });
}

// Auto-save when form changes (with debouncing)
let saveTimeout;
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('step3Form');
    if (form) {
        form.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveFormData, 2000); // Save 2 seconds after user stops typing
        });
        
        form.addEventListener('change', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveFormData, 1000); // Save 1 second after dropdown/checkbox change
        });
    }
});
</script>
{% endblock %}
