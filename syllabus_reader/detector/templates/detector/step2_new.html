{% extends 'aigames/gamepage.html' %}
{% load static %}

{% block title %}{{ step_name }} - {{ matchup.ai_game.title }}{% endblock %}

{% block extra_step_css %}
<link rel="stylesheet" href="{% static 'detector/css/steps.css' %}">
<style>
    .environments-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 20px;
        height: 800px;
        margin-bottom: 20px;
    }
    
    .environment-panel {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
    }
    
    .environment-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }
    
    .environment-header h6 {
        margin: 0;
        font-weight: bold;
        color: #495057;
    }
    
    .environment-header .subtitle {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .canvas-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: white;
        border-radius: 4px;
        border: 1px solid #ced4da;
    }
    
    .environment-canvas {
        width: 100%;
        height: 100%;
        max-height: 300px;
    }
    
    .simulation-controls {
        text-align: center;
        margin-top: 20px;
        padding: 20px;
        background-color: #e9ecef;
        border-radius: 8px;
    }
    
    .simulation-controls h5 {
        margin-bottom: 15px;
        color: #495057;
    }
    
    .btn-group .btn {
        margin: 0 5px;
    }
    
    .time-display {
        font-size: 1.2rem;
        font-weight: bold;
        color: #007bff;
        margin: 10px 0;
    }
    
    /* Environment-specific styling */
    .classroom { border-color: #007bff; }
    .classroom .environment-header { background-color: #e3f2fd; }
    
    .park { border-color: #28a745; }
    .park .environment-header { background-color: #e8f5e8; }
    
    .road { border-color: #dc3545; }
    .road .environment-header { background-color: #ffeaea; }
    
    .corridor { border-color: #ffc107; }
    .corridor .environment-header { background-color: #fff8e1; }
</style>
{% endblock %}

{% block step_content %}
    <!-- Step 2 Specific Content -->
    <div class="detector-form-section">
        <div class="mb-4 text-center">
            <h5><i class="fas fa-chart-line me-2"></i>Daily CO₂ Monitoring - Multiple Environments</h5>
            <p>Compare CO₂ levels across four different environments over a 24-hour period (accelerated simulation)</p>
        </div>

        <!-- Four Environment Grid -->
        <div class="environments-grid">
            <!-- Top Left: Park -->
            <div class="environment-panel park">
                <div class="environment-header">
                    <h6><i class="fas fa-tree me-2"></i>City Park</h6>
                    <div class="subtitle">Open outdoor space with vegetation</div>
                </div>
                <div class="canvas-container">
                    <canvas id="parkCanvas" class="environment-canvas"></canvas>
                </div>
            </div>

            <!-- Top Right: Classroom -->
            <div class="environment-panel classroom">
                <div class="environment-header">
                    <h6><i class="fas fa-chalkboard-teacher me-2"></i>Classroom</h6>
                    <div class="subtitle">Indoor learning environment</div>
                </div>
                <div class="canvas-container">
                    <canvas id="classroomCanvas" class="environment-canvas"></canvas>
                </div>
            </div>

            <!-- Bottom Left: Road -->
            <div class="environment-panel road">
                <div class="environment-header">
                    <h6><i class="fas fa-road me-2"></i>Busy Road</h6>
                    <div class="subtitle">High traffic urban street</div>
                </div>
                <div class="canvas-container">
                    <canvas id="roadCanvas" class="environment-canvas"></canvas>
                </div>
            </div>

            <!-- Bottom Right: School Corridor -->
            <div class="environment-panel corridor">
                <div class="environment-header">
                    <h6><i class="fas fa-school me-2"></i>School Corridor</h6>
                    <div class="subtitle">Indoor hallway with foot traffic</div>
                </div>
                <div class="canvas-container">
                    <canvas id="corridorCanvas" class="environment-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Simulation Controls -->
        <div class="simulation-controls">
            <h5><i class="fas fa-clock me-2"></i>24-Hour Simulation Control</h5>
            <div class="time-display" id="timeDisplay">00:00 (Midnight)</div>
            
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" id="startAllBtn">
                    <i class="fas fa-play me-1"></i>Start All Monitors
                </button>
                <button type="button" class="btn btn-warning" id="pauseAllBtn" disabled>
                    <i class="fas fa-pause me-1"></i>Pause
                </button>
                <button type="button" class="btn btn-danger" id="stopAllBtn" disabled>
                    <i class="fas fa-stop me-1"></i>Stop
                </button>
                <button type="button" class="btn btn-secondary" id="resetAllBtn">
                    <i class="fas fa-undo me-1"></i>Reset All
                </button>
            </div>
            
            <div class="mt-3">
                <small class="text-muted">
                    Simulation Speed: 1 second = 1 hour of real time
                </small>
            </div>
        </div>
    </div>
{% endblock %}

{% block step_scripts %}
<script>
class EnvironmentSimulator {
    constructor(canvasId, environmentType) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.environmentType = environmentType;
        this.data = [];
        this.isRunning = false;
        this.isPaused = false;
        this.currentHour = 0;
        this.animationId = null;
        
        this.setupCanvas();
        this.setupEnvironmentData();
    }
    
    setupCanvas() {
        this.canvas.width = this.canvas.clientWidth;
        this.canvas.height = this.canvas.clientHeight;
    }
    
    setupEnvironmentData() {
        // Define CO2 patterns for each environment over 24 hours
        const patterns = {
            park: {
                baseline: 380,
                pattern: [380, 375, 370, 365, 360, 355, 350, 360, 370, 380, 390, 400, 410, 420, 415, 410, 405, 400, 395, 390, 385, 380, 375, 370]
            },
            classroom: {
                baseline: 400,
                pattern: [400, 400, 400, 400, 400, 400, 450, 550, 800, 900, 850, 750, 600, 750, 900, 950, 800, 650, 500, 450, 420, 410, 405, 400]
            },
            road: {
                baseline: 450,
                pattern: [420, 410, 400, 390, 400, 450, 550, 650, 800, 750, 700, 680, 720, 750, 780, 850, 900, 950, 800, 650, 550, 500, 460, 440]
            },
            corridor: {
                baseline: 420,
                pattern: [420, 420, 420, 420, 420, 430, 480, 520, 600, 550, 500, 480, 520, 580, 620, 600, 550, 500, 460, 440, 430, 425, 422, 420]
            }
        };
        
        this.environmentData = patterns[this.environmentType];
    }
    
    start() {
        if (!this.isRunning && !this.isPaused) {
            this.currentHour = 0;
            this.data = [];
        }
        this.isRunning = true;
        this.isPaused = false;
        this.animate();
    }
    
    pause() {
        this.isPaused = true;
        this.isRunning = false;
        if (this.animationId) {
            clearTimeout(this.animationId);
        }
    }
    
    stop() {
        this.isRunning = false;
        this.isPaused = false;
        this.currentHour = 0;
        if (this.animationId) {
            clearTimeout(this.animationId);
        }
        this.updateButtonStates();
    }
    
    reset() {
        this.stop();
        this.data = [];
        this.currentHour = 0;
        this.drawGraph();
        this.updateTimeDisplay();
    }
    
    animate() {
        if (!this.isRunning || this.isPaused) return;
        
        if (this.currentHour < 24) {
            const ppm = this.environmentData.pattern[this.currentHour];
            this.data.push({
                hour: this.currentHour,
                ppm: ppm + (Math.random() - 0.5) * 10 // Add some random variation
            });
            
            this.currentHour++;
            this.drawGraph();
            this.updateTimeDisplay();
            
            // Continue animation every second (representing 1 hour)
            this.animationId = setTimeout(() => this.animate(), 1000);
        } else {
            this.stop();
        }
    }
    
    drawGraph() {
        const ctx = this.ctx;
        const width = this.canvas.width;
        const height = this.canvas.height;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        if (this.data.length === 0) {
            // Draw empty graph with axes
            this.drawAxes();
            return;
        }
        
        // Draw axes
        this.drawAxes();
        
        // Draw data line
        ctx.strokeStyle = this.getEnvironmentColor();
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        const margin = 50;
        const graphWidth = width - 2 * margin;
        const graphHeight = height - 2 * margin;
        
        const maxPPM = Math.max(...this.data.map(d => d.ppm), 1000);
        const minPPM = Math.min(...this.data.map(d => d.ppm), 300);
        
        this.data.forEach((point, index) => {
            const x = margin + (point.hour / 23) * graphWidth;
            const y = height - margin - ((point.ppm - minPPM) / (maxPPM - minPPM)) * graphHeight;
            
            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        
        ctx.stroke();
        
        // Draw data points
        ctx.fillStyle = this.getEnvironmentColor();
        this.data.forEach(point => {
            const x = margin + (point.hour / 23) * graphWidth;
            const y = height - margin - ((point.ppm - minPPM) / (maxPPM - minPPM)) * graphHeight;
            
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        });
    }
    
    drawAxes() {
        const ctx = this.ctx;
        const width = this.canvas.width;
        const height = this.canvas.height;
        const margin = 50;
        
        ctx.strokeStyle = '#666';
        ctx.lineWidth = 1;
        ctx.font = '12px Arial';
        ctx.fillStyle = '#666';
        
        // Y-axis
        ctx.beginPath();
        ctx.moveTo(margin, margin);
        ctx.lineTo(margin, height - margin);
        ctx.stroke();
        
        // X-axis
        ctx.beginPath();
        ctx.moveTo(margin, height - margin);
        ctx.lineTo(width - margin, height - margin);
        ctx.stroke();
        
        // X-axis labels (hours)
        for (let i = 0; i <= 24; i += 6) {
            const x = margin + (i / 24) * (width - 2 * margin);
            ctx.fillText(`${i}:00`, x - 15, height - margin + 20);
        }
        
        // Y-axis label
        ctx.save();
        ctx.translate(20, height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.textAlign = 'center';
        ctx.fillText('CO₂ (ppm)', 0, 0);
        ctx.restore();
        
        // X-axis label
        ctx.textAlign = 'center';
        ctx.fillText('Time (24-hour format)', width / 2, height - 10);
    }
    
    getEnvironmentColor() {
        const colors = {
            park: '#28a745',
            classroom: '#007bff',
            road: '#dc3545',
            corridor: '#ffc107'
        };
        return colors[this.environmentType] || '#666';
    }
    
    updateTimeDisplay() {
        const timeDisplay = document.getElementById('timeDisplay');
        if (timeDisplay && this.currentHour <= 24) {
            const hour = this.currentHour.toString().padStart(2, '0');
            timeDisplay.textContent = `${hour}:00 ${this.getTimeLabel(this.currentHour)}`;
        }
    }
    
    getTimeLabel(hour) {
        if (hour === 0) return '(Midnight)';
        if (hour === 6) return '(Dawn)';
        if (hour === 12) return '(Noon)';
        if (hour === 18) return '(Evening)';
        if (hour < 12) return '(Morning)';
        if (hour < 18) return '(Afternoon)';
        return '(Night)';
    }
    
    updateButtonStates() {
        // This will be called by the main controller
    }
}

// Global simulators
let simulators = {};

// Initialize simulators
document.addEventListener('DOMContentLoaded', function() {
    simulators = {
        park: new EnvironmentSimulator('parkCanvas', 'park'),
        classroom: new EnvironmentSimulator('classroomCanvas', 'classroom'),
        road: new EnvironmentSimulator('roadCanvas', 'road'),
        corridor: new EnvironmentSimulator('corridorCanvas', 'corridor')
    };
    
    // Setup button event listeners
    document.getElementById('startAllBtn').addEventListener('click', startAllSimulations);
    document.getElementById('pauseAllBtn').addEventListener('click', pauseAllSimulations);
    document.getElementById('stopAllBtn').addEventListener('click', stopAllSimulations);
    document.getElementById('resetAllBtn').addEventListener('click', resetAllSimulations);
    
    // Initial draw
    Object.values(simulators).forEach(sim => sim.drawGraph());
});

function startAllSimulations() {
    Object.values(simulators).forEach(sim => sim.start());
    updateGlobalButtons();
}

function pauseAllSimulations() {
    Object.values(simulators).forEach(sim => sim.pause());
    updateGlobalButtons();
}

function stopAllSimulations() {
    Object.values(simulators).forEach(sim => sim.stop());
    updateGlobalButtons();
}

function resetAllSimulations() {
    Object.values(simulators).forEach(sim => sim.reset());
    updateGlobalButtons();
}

function updateGlobalButtons() {
    const startBtn = document.getElementById('startAllBtn');
    const pauseBtn = document.getElementById('pauseAllBtn');
    const stopBtn = document.getElementById('stopAllBtn');
    
    const anyRunning = Object.values(simulators).some(sim => sim.isRunning);
    const anyPaused = Object.values(simulators).some(sim => sim.isPaused);
    
    startBtn.disabled = anyRunning;
    pauseBtn.disabled = !anyRunning;
    stopBtn.disabled = !anyRunning && !anyPaused;
}

// Handle window resize
window.addEventListener('resize', function() {
    Object.values(simulators).forEach(sim => {
        sim.setupCanvas();
        sim.drawGraph();
    });
});
</script>
{% endblock %}
