{% extends 'syllabus/base.html' %}
{% load static %}

{% block title %}{{ step_name }} - {{ matchup.ai_game.title }}{% endblock %}

{% block extra_css %}
<style>
    .game-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .game-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .card-header-custom {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    
    .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .card-subtitle {
        color: #6c757d;
        font-size: 0.95rem;
    }
    
    .score-display {
        display: flex;
        justify-content: space-between;
        align-items: stretch;
        gap: 15px;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .score-team {
        flex: 1;
        padding: 15px;
        border-radius: 6px;
        color: #495057;
        font-weight: 500;
        background: #ffffff;
        border: 1px solid #dee2e6;
        text-align: center;
    }
    
    .your-team-score {
        border-left: 3px solid #007bff;
    }
    
    .opponent-team-score {
        border-left: 3px solid #6c757d;
    }
    
    .tie-score {
        border-left: 3px solid #6c757d;
    }
    
    .score-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .team-name {
        font-size: 1.1rem;
        margin-bottom: 5px;
    }
    
    .result-banner {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .victory-banner {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: white;
    }
    
    .defeat-banner {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    
    .tie-banner {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        color: #212529;
    }
    
    .lesson-item {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin: 15px 0;
        border-radius: 0 8px 8px 0;
    }
    
    .lesson-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    
    .lesson-content {
        color: #495057;
        line-height: 1.5;
    }
    
    /* Pseudocode styling defined at end of CSS block */
    
    .step-progress {
        background: #e9ecef;
        border-radius: 20px;
        height: 8px;
        margin: 20px 0;
        overflow: hidden;
    }
    
    .step-progress-bar {
        background: linear-gradient(90deg, #28a745, #20c997);
        height: 100%;
        transition: width 0.3s ease;
        width: 100%;
    }
    
    .icon-circle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 15px;
        font-size: 1.2rem;
    }
    
    .icon-trophy {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    
    .icon-lightbulb {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
    }
    
    .icon-code {
        background: linear-gradient(135deg, #6f42c1, #5a32a3);
        color: white;
    }
    
    .performance-metric {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin: 10px 0;
        border-radius: 0 8px 8px 0;
    }
    
    /* Dark Mode IDE Styling - OVERRIDE ALL */
    div.pseudocode-container {
        background: #1e1e1e !important;
        color: #d4d4d4 !important;
        border-radius: 8px !important;
        padding: 24px !important;
        font-family: 'Fira Code', 'Consolas', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
        font-size: 14px !important;
        line-height: 1.5 !important;
        overflow-x: auto;
        border: 1px solid #3c3c3c !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
        position: relative;
        margin: 20px 0 !important;
    }
    
    div.pseudocode-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 32px;
        background: linear-gradient(180deg, #2d2d30 0%, #252526 100%) !important;
        border-radius: 8px 8px 0 0;
        border-bottom: 1px solid #3c3c3c;
        z-index: 1;
    }
    
    div.pseudocode-container::after {
        content: "● ● ●";
        position: absolute;
        top: 8px;
        left: 12px;
        font-size: 12px;
        color: #ff5f57 !important;
        letter-spacing: 4px;
        z-index: 2;
    }
    
    div.pseudocode-container .code-content {
        margin-top: 40px;
        position: relative;
        z-index: 0;
        counter-reset: line-numbering;
    }
    
    div.pseudocode-container .code-content .code-line {
        counter-increment: line-numbering;
        position: relative;
        padding-left: 50px;
        margin: 2px 0;
        color: #d4d4d4 !important;
    }
    
    div.pseudocode-container .code-content .code-line::before {
        content: counter(line-numbering);
        position: absolute;
        left: 0;
        top: 0;
        width: 40px;
        color: #858585 !important;
        font-size: 12px;
        text-align: right;
        user-select: none;
        padding-right: 10px;
    }
    
    div.pseudocode-container .code-comment {
        color: #6a9955 !important;
        font-style: italic;
    }
    
    div.pseudocode-container .code-keyword {
        color: #569cd6 !important;
        font-weight: 600;
    }
    
    div.pseudocode-container .code-function {
        color: #dcdcaa !important;
        font-weight: 600;
    }
    
    div.pseudocode-container .code-variable {
        color: #9cdcfe !important;
    }
    
    div.pseudocode-container .code-number {
        color: #b5cea8 !important;
    }
    
    div.pseudocode-container .code-string {
        color: #ce9178 !important;
    }
    
    div.pseudocode-container .code-operator {
        color: #d4d4d4 !important;
        font-weight: 500;
    }
    
    div.pseudocode-container .code-bracket {
        color: #ffd700 !important;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Instructions Button -->
    <div style="position: fixed; top: 50%; left: 0; transform: translateY(-50%); z-index: 99999;">
        <button class="btn btn-primary" 
                type="button" 
                data-bs-toggle="offcanvas" 
                data-bs-target="#instructionsOffcanvas"
                style="border-radius: 0 10px 10px 0; border-left: none; padding: 20px 10px; writing-mode: vertical-rl; text-orientation: mixed; font-size: 11px; font-weight: bold; min-height: 120px;">
            Instructions
        </button>
    </div>

    <!-- Instructions Offcanvas -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="instructionsOffcanvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Step Instructions</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            {% if instructions %}
                {% for instruction in instructions %}
                    <div class="mb-3">
                        <p>{{ instruction.content|linebreaks }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <p>Review the final results of your overlap detection game. This step shows your team's performance, key lessons learned, and the algorithmic approach to finding optimal overlaps.</p>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">{{ step_name }}</h4>
                        <small class="text-muted">Step {{ current_step }} of {{ total_steps }} - Final Results</small>
                    </div>
                    <div class="text-right">
                        <span class="badge badge-info">{{ team.name }}</span>
                        {% if matchup.ai_game.school %}
                            <span class="badge badge-secondary">{{ matchup.ai_game.school.name }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">

                    <!-- Card 1: Game Results -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-bullseye"></i> Final Game Results
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Result Banner -->
                            {% if game_result == "victory" %}
                                <div class="result-banner victory-banner">
                                    <i class="fas fa-crown"></i> Congratulations! Your team won!
                                </div>
                            {% elif game_result == "defeat" %}
                                <div class="result-banner defeat-banner">
                                    <i class="fas fa-handshake"></i> Good game! Better luck next time!
                                </div>
                            {% else %}
                                <div class="result-banner tie-banner">
                                    <i class="fas fa-balance-scale"></i> It's a tie! Both teams performed equally well!
                                </div>
                            {% endif %}

                            <!-- Score Display -->
                            <div class="score-display">
                                <div class="score-team your-team-score">
                                    <div class="team-name">{{ team.name }}</div>
                                    <div class="score-number">{{ team_score }}</div>
                                    <div>Final Score</div>
                                </div>
                                <div class="score-team opponent-team-score">
                                    <div class="team-name">{{ opponent_team.name }}</div>
                                    <div class="score-number">{{ opponent_score }}</div>
                                    <div>Final Score</div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Card 2: Game Analysis & Learning -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-graduation-cap"></i> Game Analysis & Learning
                            </h5>
                        </div>
                        <div class="card-body">



                        <!-- Key Lessons Learned -->
                        <div class="mb-4">
                            <h6><i class="fas fa-lightbulb"></i> Key Lessons Learned</h6>
                            
                            <div class="lesson-item">
                                <div class="lesson-title">Strategic Planning is Essential</div>
                                <div class="lesson-content">
                                    Successful overlap detection requires careful consideration of placement strategy. Teams that documented their approach and reasoning typically performed better than those who placed circles randomly.
                                </div>
                            </div>

                            <div class="lesson-item">
                                <div class="lesson-title">Systematic Evaluation Beats Random Clicking</div>
                                <div class="lesson-content">
                                    Teams that used systematic approaches (like grid patterns or boundary testing) were more effective at evaluating opponent circles than those who clicked randomly. Pattern recognition and methodical testing are key skills in data analysis.
                                </div>
                            </div>

                            <div class="lesson-item">
                                <div class="lesson-title">Computational Thinking in Action</div>
                                <div class="lesson-content">
                                    This game demonstrates core computational thinking concepts: decomposition (breaking the problem into steps), pattern recognition (identifying optimal placement areas), abstraction (representing complex overlap calculations), and algorithms (systematic approaches to evaluation).
                                </div>
                            </div>

                            <div class="lesson-item">
                                <div class="lesson-title">Real-World Applications</div>
                                <div class="lesson-content">
                                    Overlap detection algorithms are used in many real-world scenarios: image processing, collision detection in games, geographic information systems (GIS), medical imaging analysis, and optimization problems in logistics and manufacturing.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card 3: Algorithmic Approach -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-code"></i> Algorithmic Approach
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Pseudocode for finding optimal overlap placement:</p>
                            
                            <div class="pseudocode-container">
                                <div class="code-content">
<div class="code-line"><span class="code-comment">// Algorithm to find optimal circle placement for maximum overlap</span></div>
<div class="code-line"><span class="code-keyword">function</span> <span class="code-function">findOptimalOverlap</span><span class="code-bracket">(</span><span class="code-variable">targetArea</span>, <span class="code-variable">circleRadius</span><span class="code-bracket">)</span> <span class="code-bracket">{</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-variable">bestScore</span> <span class="code-operator">=</span> <span class="code-number">0</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-variable">bestPosition</span> <span class="code-operator">=</span> <span class="code-keyword">null</span></div>
<div class="code-line"></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Grid search approach - test multiple positions</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">for</span> <span class="code-bracket">(</span><span class="code-variable">x</span> <span class="code-operator">=</span> <span class="code-number">0</span>; <span class="code-variable">x</span> <span class="code-operator">&lt;</span> <span class="code-variable">canvasWidth</span>; <span class="code-variable">x</span> <span class="code-operator">+=</span> <span class="code-variable">stepSize</span><span class="code-bracket">)</span> <span class="code-bracket">{</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">for</span> <span class="code-bracket">(</span><span class="code-variable">y</span> <span class="code-operator">=</span> <span class="code-number">0</span>; <span class="code-variable">y</span> <span class="code-operator">&lt;</span> <span class="code-variable">canvasHeight</span>; <span class="code-variable">y</span> <span class="code-operator">+=</span> <span class="code-variable">stepSize</span><span class="code-bracket">)</span> <span class="code-bracket">{</span></div>
<div class="code-line"></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Calculate overlap score for this position</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-variable">overlapScore</span> <span class="code-operator">=</span> <span class="code-function">calculateOverlap</span><span class="code-bracket">(</span><span class="code-variable">x</span>, <span class="code-variable">y</span>, <span class="code-variable">circleRadius</span>, <span class="code-variable">targetArea</span><span class="code-bracket">)</span></div>
<div class="code-line"></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Keep track of best position found so far</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">if</span> <span class="code-bracket">(</span><span class="code-variable">overlapScore</span> <span class="code-operator">&gt;</span> <span class="code-variable">bestScore</span><span class="code-bracket">)</span> <span class="code-bracket">{</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-variable">bestScore</span> <span class="code-operator">=</span> <span class="code-variable">overlapScore</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-variable">bestPosition</span> <span class="code-operator">=</span> <span class="code-bracket">{</span><span class="code-variable">x</span>: <span class="code-variable">x</span>, <span class="code-variable">y</span>: <span class="code-variable">y</span><span class="code-bracket">}</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-bracket">}</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-bracket">}</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-bracket">}</span></div>
<div class="code-line"></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Refine search around best position found</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-variable">refinedPosition</span> <span class="code-operator">=</span> <span class="code-function">localSearch</span><span class="code-bracket">(</span><span class="code-variable">bestPosition</span>, <span class="code-variable">circleRadius</span>, <span class="code-variable">targetArea</span><span class="code-bracket">)</span></div>
<div class="code-line"></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span> <span class="code-variable">refinedPosition</span></div>
<div class="code-line"><span class="code-bracket">}</span></div>
<div class="code-line"></div>
<div class="code-line"><span class="code-keyword">function</span> <span class="code-function">calculateOverlap</span><span class="code-bracket">(</span><span class="code-variable">circleX</span>, <span class="code-variable">circleY</span>, <span class="code-variable">radius</span>, <span class="code-variable">targetArea</span><span class="code-bracket">)</span> <span class="code-bracket">{</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-variable">overlapPixels</span> <span class="code-operator">=</span> <span class="code-number">0</span></div>
<div class="code-line"></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Sample points within the circle</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">for</span> <span class="code-bracket">(</span><span class="code-variable">i</span> <span class="code-operator">=</span> <span class="code-operator">-</span><span class="code-variable">radius</span>; <span class="code-variable">i</span> <span class="code-operator">&lt;=</span> <span class="code-variable">radius</span>; <span class="code-variable">i</span><span class="code-operator">++</span><span class="code-bracket">)</span> <span class="code-bracket">{</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">for</span> <span class="code-bracket">(</span><span class="code-variable">j</span> <span class="code-operator">=</span> <span class="code-operator">-</span><span class="code-variable">radius</span>; <span class="code-variable">j</span> <span class="code-operator">&lt;=</span> <span class="code-variable">radius</span>; <span class="code-variable">j</span><span class="code-operator">++</span><span class="code-bracket">)</span> <span class="code-bracket">{</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Check if point is inside circle</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">if</span> <span class="code-bracket">(</span><span class="code-variable">i</span><span class="code-operator">*</span><span class="code-variable">i</span> <span class="code-operator">+</span> <span class="code-variable">j</span><span class="code-operator">*</span><span class="code-variable">j</span> <span class="code-operator">&lt;=</span> <span class="code-variable">radius</span><span class="code-operator">*</span><span class="code-variable">radius</span><span class="code-bracket">)</span> <span class="code-bracket">{</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Check if this point overlaps with target area</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">if</span> <span class="code-bracket">(</span><span class="code-function">isInTargetArea</span><span class="code-bracket">(</span><span class="code-variable">circleX</span> <span class="code-operator">+</span> <span class="code-variable">i</span>, <span class="code-variable">circleY</span> <span class="code-operator">+</span> <span class="code-variable">j</span>, <span class="code-variable">targetArea</span><span class="code-bracket">)</span><span class="code-bracket">)</span> <span class="code-bracket">{</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-variable">overlapPixels</span><span class="code-operator">++</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-bracket">}</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-bracket">}</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-bracket">}</span></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-bracket">}</span></div>
<div class="code-line"></div>
<div class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span> <span class="code-variable">overlapPixels</span></div>
<div class="code-line"><span class="code-bracket">}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{% url 'overlap:step4' matchup.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i>
                                ← Back to Step 4
                            </a>
                        </div>
                        <div class="text-center">
                            <span class="badge badge-success px-3 py-2">
                                <i class="fas fa-flag-checkered"></i> Game Complete!
                            </span>
                        </div>
                        <div>
                            <a href="{% url 'overlap:complete_step' matchup.id %}" class="btn btn-primary">
                                <i class="fas fa-trophy"></i>
                                View Final Results →
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
