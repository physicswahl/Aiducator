{% extends 'aigames/base.html' %}
{% load static %}

{% block title %}{{ step_name }} - {{ matchup.ai_game.title }}{% endblock %}

{% block extra_css %}
<style>
    .game-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .game-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .card-header-custom {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    
    .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .card-subtitle {
        color: #6c757d;
        font-size: 0.95rem;
    }
    
    .score-display {
        text-align: center;
        padding: 20px;
        border-radius: 8px;
        margin: 15px 0;
    }
    
    .score-team {
        display: inline-block;
        width: 45%;
        margin: 0 2.5%;
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-weight: bold;
    }
    
    .your-team-score {
        background: linear-gradient(135deg, #007bff, #0056b3);
    }
    
    .opponent-team-score {
        background: linear-gradient(135deg, #dc3545, #a71e2a);
    }
    
    .tie-score {
        background: linear-gradient(135deg, #6c757d, #495057);
    }
    
    .score-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .team-name {
        font-size: 1.1rem;
        margin-bottom: 5px;
    }
    
    .result-banner {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .victory-banner {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: white;
    }
    
    .defeat-banner {
        background: linear-gradient(135deg, #dc3545, #a71e2a);
        color: white;
    }
    
    .tie-banner {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        color: #212529;
    }
    
    .lesson-item {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin: 15px 0;
        border-radius: 0 8px 8px 0;
    }
    
    .lesson-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    
    .lesson-content {
        color: #495057;
        line-height: 1.5;
    }
    
    .pseudocode-container {
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.6;
        overflow-x: auto;
    }
    
    .code-comment {
        color: #68d391;
        font-style: italic;
    }
    
    .code-keyword {
        color: #63b3ed;
        font-weight: bold;
    }
    
    .code-function {
        color: #f6ad55;
    }
    
    .code-variable {
        color: #d6f5d6;
    }
    
    .code-number {
        color: #fbb6ce;
    }
    
    .step-progress {
        background: #e9ecef;
        border-radius: 20px;
        height: 8px;
        margin: 20px 0;
        overflow: hidden;
    }
    
    .step-progress-bar {
        background: linear-gradient(90deg, #28a745, #20c997);
        height: 100%;
        transition: width 0.3s ease;
        width: 100%;
    }
    
    .icon-circle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 15px;
        font-size: 1.2rem;
    }
    
    .icon-trophy {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        color: #212529;
    }
    
    .icon-lightbulb {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
    }
    
    .icon-code {
        background: linear-gradient(135deg, #6f42c1, #5a32a3);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Instructions Button -->
    <div style="position: fixed; top: 50%; left: 0; transform: translateY(-50%); z-index: 99999;">
        <button class="btn btn-primary" 
                type="button" 
                data-bs-toggle="offcanvas" 
                data-bs-target="#instructionsOffcanvas"
                style="border-radius: 0 10px 10px 0; border-left: none; padding: 20px 10px; writing-mode: vertical-rl; text-orientation: mixed; font-size: 11px; font-weight: bold; min-height: 120px;">
            Instructions
        </button>
    </div>

    <!-- Instructions Offcanvas -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="instructionsOffcanvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Step Instructions</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            {% if instructions %}
                {% for instruction in instructions %}
                    <div class="mb-3">
                        <p>{{ instruction.content|linebreaks }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <p>Review the final results of your overlap detection game. This step shows your team's performance, key lessons learned, and the algorithmic approach to finding optimal overlaps.</p>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">{{ step_name }}</h4>
                        <small class="text-muted">Step {{ current_step }} of {{ total_steps }} - Final Results</small>
                    </div>
                    <div class="text-right">
                        <span class="badge badge-info">{{ team.name }}</span>
                        {% if matchup.ai_game.school %}
                            <span class="badge badge-secondary">{{ matchup.ai_game.school.name }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="step-progress">
                        <div class="step-progress-bar"></div>
                    </div>

                    <!-- Card 1: Team Scores -->
                    <div class="game-card">
                        <div class="card-header-custom">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle icon-trophy">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div>
                                    <h5 class="card-title">Final Scores</h5>
                                    <p class="card-subtitle">Performance summary for both teams</p>
                                </div>
                            </div>
                        </div>

                        <!-- Result Banner -->
                        {% if game_result == "victory" %}
                            <div class="result-banner victory-banner">
                                <i class="fas fa-crown"></i> Congratulations! Your team won!
                            </div>
                        {% elif game_result == "defeat" %}
                            <div class="result-banner defeat-banner">
                                <i class="fas fa-handshake"></i> Good game! Better luck next time!
                            </div>
                        {% else %}
                            <div class="result-banner tie-banner">
                                <i class="fas fa-balance-scale"></i> It's a tie! Both teams performed equally well!
                            </div>
                        {% endif %}

                        <!-- Score Display -->
                        <div class="score-display">
                            <div class="score-team your-team-score">
                                <div class="team-name">{{ team.name }}</div>
                                <div class="score-number">{{ team_score }}</div>
                                <div>Points</div>
                            </div>
                            <div class="score-team opponent-team-score">
                                <div class="team-name">{{ opponent_team.name }}</div>
                                <div class="score-number">{{ opponent_score }}</div>
                                <div>Points</div>
                            </div>
                        </div>

                        <!-- Score Breakdown -->
                        <div class="mt-4">
                            <h6><i class="fas fa-chart-line"></i> Scoring Breakdown</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <strong>Points are awarded for:</strong><br>
                                        • Step Completion (8 pts per step)<br>
                                        • Strategy Quality (up to 30 pts)<br>
                                        • Engagement Level (up to 20 pts)<br>
                                        • Circle Placement (up to 10 pts)
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <strong>Your team's highlights:</strong><br>
                                        • {{ team_data.click_count }} evaluation clicks made<br>
                                        • {% if team_data.placement_notes %}Strategic placement documented{% else %}Basic placement approach{% endif %}<br>
                                        • {% if team_data.evaluation_strategy %}Detailed evaluation strategy{% else %}Simple evaluation approach{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card 2: Main Lessons Learned -->
                    <div class="game-card">
                        <div class="card-header-custom">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle icon-lightbulb">
                                    <i class="fas fa-lightbulb"></i>
                                </div>
                                <div>
                                    <h5 class="card-title">Key Lessons Learned</h5>
                                    <p class="card-subtitle">Important insights from the overlap detection game</p>
                                </div>
                            </div>
                        </div>

                        <div class="lesson-item">
                            <div class="lesson-title">Strategic Planning is Essential</div>
                            <div class="lesson-content">
                                Successful overlap detection requires careful consideration of placement strategy. Teams that documented their approach and reasoning typically performed better than those who placed circles randomly.
                            </div>
                        </div>

                        <div class="lesson-item">
                            <div class="lesson-title">Systematic Evaluation Beats Random Clicking</div>
                            <div class="lesson-content">
                                Teams that used systematic approaches (like grid patterns or boundary testing) were more effective at evaluating opponent circles than those who clicked randomly. Pattern recognition and methodical testing are key skills in data analysis.
                            </div>
                        </div>

                        <div class="lesson-item">
                            <div class="lesson-title">Computational Thinking in Action</div>
                            <div class="lesson-content">
                                This game demonstrates core computational thinking concepts: decomposition (breaking the problem into steps), pattern recognition (identifying optimal placement areas), abstraction (representing complex overlap calculations), and algorithms (systematic approaches to evaluation).
                            </div>
                        </div>

                        <div class="lesson-item">
                            <div class="lesson-title">Real-World Applications</div>
                            <div class="lesson-content">
                                Overlap detection algorithms are used in many real-world scenarios: image processing, collision detection in games, geographic information systems (GIS), medical imaging analysis, and optimization problems in logistics and manufacturing.
                            </div>
                        </div>
                    </div>

                    <!-- Card 3: Pseudocode for Optimal Overlap Detection -->
                    <div class="game-card">
                        <div class="card-header-custom">
                            <div class="d-flex align-items-center">
                                <div class="icon-circle icon-code">
                                    <i class="fas fa-code"></i>
                                </div>
                                <div>
                                    <h5 class="card-title">Algorithmic Approach</h5>
                                    <p class="card-subtitle">Pseudocode for finding optimal overlap placement</p>
                                </div>
                            </div>
                        </div>

                        <div class="pseudocode-container">
<span class="code-comment">// Algorithm to find optimal circle placement for maximum overlap</span>
<span class="code-keyword">function</span> <span class="code-function">findOptimalOverlap</span>(<span class="code-variable">targetArea</span>, <span class="code-variable">circleRadius</span>) {
    <span class="code-variable">bestScore</span> = <span class="code-number">0</span>
    <span class="code-variable">bestPosition</span> = <span class="code-keyword">null</span>
    
    <span class="code-comment">// Grid search approach - test multiple positions</span>
    <span class="code-keyword">for</span> (<span class="code-variable">x</span> = <span class="code-number">0</span>; <span class="code-variable">x</span> < <span class="code-variable">canvasWidth</span>; <span class="code-variable">x</span> += <span class="code-variable">stepSize</span>) {
        <span class="code-keyword">for</span> (<span class="code-variable">y</span> = <span class="code-number">0</span>; <span class="code-variable">y</span> < <span class="code-variable">canvasHeight</span>; <span class="code-variable">y</span> += <span class="code-variable">stepSize</span>) {
            
            <span class="code-comment">// Calculate overlap score for this position</span>
            <span class="code-variable">overlapScore</span> = <span class="code-function">calculateOverlap</span>(<span class="code-variable">x</span>, <span class="code-variable">y</span>, <span class="code-variable">circleRadius</span>, <span class="code-variable">targetArea</span>)
            
            <span class="code-comment">// Keep track of best position found so far</span>
            <span class="code-keyword">if</span> (<span class="code-variable">overlapScore</span> > <span class="code-variable">bestScore</span>) {
                <span class="code-variable">bestScore</span> = <span class="code-variable">overlapScore</span>
                <span class="code-variable">bestPosition</span> = {<span class="code-variable">x</span>: <span class="code-variable">x</span>, <span class="code-variable">y</span>: <span class="code-variable">y</span>}
            }
        }
    }
    
    <span class="code-comment">// Refine search around best position found</span>
    <span class="code-variable">refinedPosition</span> = <span class="code-function">localSearch</span>(<span class="code-variable">bestPosition</span>, <span class="code-variable">circleRadius</span>, <span class="code-variable">targetArea</span>)
    
    <span class="code-keyword">return</span> <span class="code-variable">refinedPosition</span>
}

<span class="code-keyword">function</span> <span class="code-function">calculateOverlap</span>(<span class="code-variable">circleX</span>, <span class="code-variable">circleY</span>, <span class="code-variable">radius</span>, <span class="code-variable">targetArea</span>) {
    <span class="code-variable">overlapPixels</span> = <span class="code-number">0</span>
    
    <span class="code-comment">// Sample points within the circle</span>
    <span class="code-keyword">for</span> (<span class="code-variable">i</span> = -<span class="code-variable">radius</span>; <span class="code-variable">i</span> <= <span class="code-variable">radius</span>; <span class="code-variable">i</span>++) {
        <span class="code-keyword">for</span> (<span class="code-variable">j</span> = -<span class="code-variable">radius</span>; <span class="code-variable">j</span> <= <span class="code-variable">radius</span>; <span class="code-variable">j</span>++) {
            <span class="code-comment">// Check if point is inside circle</span>
            <span class="code-keyword">if</span> (<span class="code-variable">i</span>*<span class="code-variable">i</span> + <span class="code-variable">j</span>*<span class="code-variable">j</span> <= <span class="code-variable">radius</span>*<span class="code-variable">radius</span>) {
                <span class="code-comment">// Check if this point overlaps with target area</span>
                <span class="code-keyword">if</span> (<span class="code-function">isInTargetArea</span>(<span class="code-variable">circleX</span> + <span class="code-variable">i</span>, <span class="code-variable">circleY</span> + <span class="code-variable">j</span>, <span class="code-variable">targetArea</span>)) {
                    <span class="code-variable">overlapPixels</span>++
                }
            }
        }
    }
    
    <span class="code-keyword">return</span> <span class="code-variable">overlapPixels</span>
}
                        </div>

                        <div class="mt-3">
                            <h6><i class="fas fa-info-circle"></i> Algorithm Explanation</h6>
                            <p class="text-muted">
                                This pseudocode demonstrates a <strong>grid search algorithm</strong> combined with <strong>local optimization</strong>. 
                                It systematically tests different positions, calculates overlap scores, and refines the search around promising areas. 
                                This approach balances thoroughness with computational efficiency, similar to algorithms used in computer vision and optimization problems.
                            </p>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{% url 'overlap:step4' matchup.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i>
                                ← Back to Step 4
                            </a>
                        </div>
                        <div class="text-center">
                            <span class="badge badge-success px-3 py-2">
                                <i class="fas fa-flag-checkered"></i> Game Complete!
                            </span>
                        </div>
                        <div>
                            <a href="{% url 'overlap:complete_step' matchup.id %}" class="btn btn-primary">
                                <i class="fas fa-trophy"></i>
                                View Final Results →
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
