{% extends 'aigames/base.html' %}
{% load static %}

{% block title %}{{ step_name }} - {{ matchup.ai_game.title }}{% endblock %}

{% block extra_css %}
<style>
    .reflection-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .team-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }
    
    .team-summary {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
    }
    
    .strategy-display {
        background: #f1f3f4;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-size: 0.9em;
    }
    
    .circle-info {
        display: flex;
        align-items: center;
        margin: 10px 0;
    }
    
    .circle-preview {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid #333;
    }
    
    .your-team { border-color: #007bff; background-color: rgba(0, 123, 255, 0.1); }
    .opponent-team { border-color: #dc3545; background-color: rgba(220, 53, 69, 0.1); }
    
    .reflection-textarea {
        min-height: 200px;
        resize: vertical;
    }
    
    .char-counter {
        font-size: 0.85em;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .char-counter.valid {
        color: #28a745;
    }
    
    .step-progress {
        background: #e9ecef;
        border-radius: 20px;
        height: 8px;
        margin: 20px 0;
        overflow: hidden;
    }
    
    .step-progress-bar {
        background: linear-gradient(90deg, #28a745, #20c997);
        height: 100%;
        transition: width 0.3s ease;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">{{ step_name }}</h4>
                        <small class="text-muted">Step {{ current_step }} of {{ total_steps }}</small>
                    </div>
                    <div class="text-right">
                        <span class="badge badge-info">{{ team.name }}</span>
                        {% if matchup.ai_game.school %}
                            <span class="badge badge-secondary">{{ matchup.ai_game.school.name }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="step-progress">
                        <div class="step-progress-bar"></div>
                    </div>

                    <!-- Instructions -->
                    {% if instructions %}
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> Instructions</h5>
                            {% for instruction in instructions %}
                                <p class="mb-1">{{ instruction.content|linebreaks }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Game Summary Section -->
                    <div class="reflection-section">
                        <h5><i class="fas fa-trophy"></i> Game Summary</h5>
                        <p class="text-muted">Review how both teams performed throughout the overlap detection game.</p>
                        
                        <div class="team-comparison">
                            <!-- Your Team Summary -->
                            <div class="team-summary your-team">
                                <h6><i class="fas fa-users"></i> Your Team: {{ team.name }}</h6>
                                
                                {% if team_data.circle_x and team_data.circle_y %}
                                    <div class="circle-info">
                                        <div class="circle-preview" style="border-color: #007bff; background-color: rgba(0, 123, 255, 0.2);"></div>
                                        <span>Circle placed at ({{ team_data.circle_x|floatformat:0 }}, {{ team_data.circle_y|floatformat:0 }})</span>
                                    </div>
                                {% endif %}
                                
                                {% if team_data.placement_notes %}
                                    <div class="strategy-display">
                                        <strong>Placement Strategy:</strong><br>
                                        {{ team_data.placement_notes|truncatewords:30 }}
                                    </div>
                                {% endif %}
                                
                                {% if team_data.evaluation_strategy %}
                                    <div class="strategy-display">
                                        <strong>Evaluation Strategy:</strong><br>
                                        {{ team_data.evaluation_strategy|truncatewords:30 }}
                                    </div>
                                {% endif %}
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-mouse-pointer"></i> {{ team_data.click_count }} evaluation clicks made
                                    </small>
                                </div>
                            </div>

                            <!-- Opponent Team Summary -->
                            <div class="team-summary opponent-team">
                                <h6><i class="fas fa-users"></i> Opponent Team: {{ opponent_team.name }}</h6>
                                
                                {% if opponent_team_data.circle_x and opponent_team_data.circle_y %}
                                    <div class="circle-info">
                                        <div class="circle-preview" style="border-color: #dc3545; background-color: rgba(220, 53, 69, 0.2);"></div>
                                        <span>Circle placed at ({{ opponent_team_data.circle_x|floatformat:0 }}, {{ opponent_team_data.circle_y|floatformat:0 }})</span>
                                    </div>
                                {% endif %}
                                
                                {% if opponent_team_data.placement_notes %}
                                    <div class="strategy-display">
                                        <strong>Placement Strategy:</strong><br>
                                        {{ opponent_team_data.placement_notes|truncatewords:30 }}
                                    </div>
                                {% endif %}
                                
                                {% if opponent_team_data.evaluation_strategy %}
                                    <div class="strategy-display">
                                        <strong>Evaluation Strategy:</strong><br>
                                        {{ opponent_team_data.evaluation_strategy|truncatewords:30 }}
                                    </div>
                                {% endif %}
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-mouse-pointer"></i> {{ opponent_team_data.click_count }} evaluation clicks made
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reflection Form -->
                    {% if not team_data.step5_completed %}
                        <div class="reflection-section">
                            <h5><i class="fas fa-pen"></i> Final Reflection</h5>
                            <p class="text-muted">Reflect on your team's strategy, the game experience, and what you learned.</p>
                            
                            {% if allow_form_submission %}
                                <form method="post" id="reflectionForm">
                                    {% csrf_token %}
                                    <div class="form-group">
                                        <label for="reflection_notes">
                                            <strong>Your Reflection</strong>
                                            <span class="text-danger">*</span>
                                        </label>
                                        <textarea 
                                            id="reflection_notes" 
                                            name="reflection_notes" 
                                            class="form-control reflection-textarea" 
                                            placeholder="Consider questions like:
• What was your team's overall strategy?
• How did you decide where to place your circle?
• What did you think of the opponent's strategy?
• What would you do differently next time?
• What did you learn from this game?"
                                            required>{{ team_data.reflection_notes }}</textarea>
                                        <div class="char-counter">
                                            <span id="charCount">{{ team_data.reflection_notes|length }}</span> characters (minimum 50 required)
                                        </div>
                                    </div>
                                    
                                    <button type="submit" id="submitBtn" class="btn btn-success" disabled>
                                        <i class="fas fa-check"></i> Complete Step 5
                                    </button>
                                </form>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-eye"></i> You are viewing this step in read-only mode.
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <!-- Show completed reflection -->
                        <div class="reflection-section">
                            <h5><i class="fas fa-check-circle text-success"></i> Final Reflection (Completed)</h5>
                            <div class="strategy-display">
                                {{ team_data.reflection_notes|linebreaks }}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Navigation -->
                    <div class="card-footer d-flex justify-content-between">
                        <div>
                            <a href="{% url 'overlap:step4' matchup.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i>
                                ← Back to Step 4
                            </a>
                        </div>
                        <div>
                            {% if team_data.step5_completed %}
                                <a href="{% url 'overlap:complete_step' matchup.id %}" class="btn btn-success">
                                    <i class="fas fa-flag-checkered"></i>
                                    View Game Results →
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const textarea = document.getElementById('reflection_notes');
        const charCount = document.getElementById('charCount');
        const submitBtn = document.getElementById('submitBtn');
        
        if (textarea && charCount && submitBtn) {
            function updateCharCount() {
                const currentLength = textarea.value.length;
                charCount.textContent = currentLength;
                
                // Update styling and button state
                const counterElement = charCount.parentElement;
                if (currentLength >= 50) {
                    counterElement.classList.add('valid');
                    submitBtn.disabled = false;
                } else {
                    counterElement.classList.remove('valid');
                    submitBtn.disabled = true;
                }
            }
            
            // Initial check
            updateCharCount();
            
            // Update on input
            textarea.addEventListener('input', updateCharCount);
        }
    });
</script>
{% endblock %}
